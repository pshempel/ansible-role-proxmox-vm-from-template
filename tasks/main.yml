---
# tasks/main.yml

# Initial preparation and information gathering
- name: Prepare environment and gather necessary information
  import_tasks: prepare.yml

# Verifying and selecting the desired template based on a tag or criterion
- name: Verify and select the desired template exists
  import_tasks: verify_template_exists.yml
  vars:
    template_tag: "{{ default_template_tag }}"

# Pick the correct template for cloning
- name: Select the template
  import_tasks: select_template.yml

# Check if the template is on the target node and set migration flag
- name: Check if the template is on the target node and set migration flag
  import_tasks: check_template_location.yml

# Migrate the template if necessary
- name: Migrate the template if necessary
  import_tasks: migrate_template_to_target_node.yml
  when: needs_migration

# Verify when we are passed a VMID that it does not already exist
- name: Check for Duplicate VMID when provided from playbook
  include_tasks: check_for_duplicate_vmid_vmname.yml
  loop: "{{ vms }}"
# loop_control:
#   loop_var: "custom_var"

# Cloning VMs from the selected and verified template using include_tasks for dynamic execution
- name: Clone a new VM from the template
  include_tasks: clone_vm_from_template.yml
  loop: "{{ vms }}"
  loop_control:
    loop_var: "custom_var"
  when: "custom_var.state | default('present') == 'present' and not custom_var.vmid_exists and not custom_var.vm_name_exists"

# Applying additional configurations to the newly cloned VMs
- name: Configure deployed VMs
  include_tasks: configure_vms.yml
  loop: "{{ vms }}"
  loop_control:
    loop_var: "custom_var"
