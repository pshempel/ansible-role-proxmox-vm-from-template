---
# tasks/main.yml

# Initial preparation and information gathering
- name: Prepare environment and gather necessary information
  import_tasks: prepare.yml

# Verifying and selecting the desired template based on a tag or criterion
- name: Verify and select the desired template exists
  import_tasks: verify_template_exists.yml
  vars:
    template_tag: "{{ default_template_tag }}"

# Pick the correct template for cloning
- name: Select the template
  import_tasks: select_template.yml

# Check if the template is on the target node and set migration flag
- name: Check if the template is on the target node and set migration flag
  import_tasks: check_template_location.yml

# Migrate the template if necessary
- name: Migrate the template if necessary
  import_tasks: migrate_template_to_target_node.yml
  when: needs_migration

# Verify when we are passed a VMID that it does not already exist
- name: Check for Duplicate VMID when provided from playbook
  include_tasks: check_for_duplicate_vmid_vmname.yml
  loop: "{{ vms }}"
  loop_control:
    loop_var: vm_to_clone

# Need to change variable when including an include, prevent scope issues
- name: Clone and configure VMs sequentially
  include_tasks: clone_and_configure_each_vm.yml
  loop: "{{ vms }}"
  loop_control:
    loop_var: vm_data_to_clone
