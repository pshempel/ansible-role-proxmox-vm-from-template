---
- name: Fetch available VM templates
  uri:
    url: "{{ proxmox_api_url }}/cluster/resources?type=vm"
    method: GET
    headers:
      Authorization: "PVEAPIToken={{ proxmox_api_token_id }}={{ proxmox_api_token_secret }}"
    return_content: yes
    validate_certs: no  # Adjust in production
  register: templates
  delegate_to: localhost

- name: Select VM template based on tag
  set_fact:
    set_fact:
    selected_template: "{{ templates | selectattr('tags', 'defined') | selectattr('tags', 'search', vm_item.template_tag | default('default_tag')) | first }}"
  loop: "{{ vms }}"
  loop_control:
    loop_var: item
